# docker-compose.yml for cocoindex-code-mcp-server with repository management
version: "3.9"

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: cocoindex-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: cocoindex
      POSTGRES_PASSWORD: cocoindex
      POSTGRES_DB: cocoindex
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-pgvector.sql:/docker-entrypoint-initdb.d/init-pgvector.sql:ro
    ports:
      - "5532:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cocoindex"]
      interval: 10s
      timeout: 5s
      retries: 5

  cocoindex-mcp:
    image: ghcr.io/fbrier/cocoindex-code-mcp-server:main-2a2ce74
    container_name: cocoindex-mcp-server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database connection (use 'postgres' as hostname for docker network)
      - COCOINDEX_DATABASE_URL=postgresql://cocoindex:cocoindex@postgres:5532/cocoindex

      # Directory paths in container
      - REPOS_DIR=/repos
      - CODE_FRAGMENTS_DIR=/code_fragments
      - WORKSPACE=/logs

      # SSH key for private git repositories (optional)
      # Mount your SSH key and set this path
      - GIT_SSH_KEY=/ssh/id_rsa

      # Optional: Configure git user for commits
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL}
      - SSH_KEY_FILE=${SSH_KEY_FILE}  # Path to SSH key file on host
    ports:
      - "3033:3033"  # MCP server HTTP port
    volumes:
      # Named volumes for persistent storage
      - repos:/repos                          # Git repositories
      - code_fragments:/code_fragments        # Code fragments from web
      - logs:/logs                            # Application logs

      # Mount SSH key for private repositories (optional)
      # Uncomment and adjust path to your SSH key
      - ${SSH_KEY_FILE}:/ssh/id_rsa:ro
      # Or use a specific key:
      # - ./git_deploy_key:/ssh/id_rsa:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3033/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Named volumes for data persistence
# These persist even when containers are stopped/removed
volumes:
  postgres_data:
    driver: local
  repos:
    driver: local
  code_fragments:
    driver: local
  logs:
    driver: local

# Optional: Networks configuration
networks:
  default:
    name: cocoindex-network
